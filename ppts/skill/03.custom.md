# 3. 高阶构建心法：如何写出优秀的 Skill？

> 很多人写的 Skill (或 Rules) AI 根本不听话。
> 官方 [Tool Use Best Practices](https://docs.anthropic.com/en/docs/build-with-claude/tool-use) 指出，写好 Skill 就像写好一段带严格类型校验的代码。

## 构建优质 Skill 的三大要素

<div class="grid grid-cols-3 gap-4 mt-6">

<div class="bg-blue-50 dark:bg-blue-900/[.3] p-4 rounded-lg border border-blue-200">

### 1. 清晰的边界 (Description)
**告诉 AI 什么时候该用，什么时候绝不能用**
- ❌ "用于分析代码"
- ✅ "当用户要求分析代码安全漏洞，或者触发 CVE 扫描时调用。**警告：仅支持 `.ts` 和 `.js` 文件，不要在 Python 目录中调用**。"

</div>

<div class="bg-purple-50 dark:bg-purple-900/[.3] p-4 rounded-lg border border-purple-200">

### 2. 严格的入参 (Schema)
**约束大模型的发挥空间**
- 不要让模型传递自由文本。
- 使用强类型的 JSON Schema（或 YAML 参数定义），配合 Enum 限制选项，配合 Required 字段避免缺失。

</div>

<div class="bg-green-50 dark:bg-green-900/[.3] p-4 rounded-lg border border-green-200">

### 3. 兜底与容错 (Fallback)
**失败了怎么办？**
- 如果外部 API 超时，不要让 AI 陷入死循环。
- 在提示词中明确写出："如果工具报错超过 2 次，请立即停止尝试，并向用户报告具体的报错信息，附带解决方案建议。"

</div>

</div>

---

# Tool 定义四段式讲解

> 根据 Anthropic 官方文档，每个 Tool 定义都应包含以下要素。

## 定义

Tool 是让 LLM 主动调用以完成特定任务的机制。

## 原理

Claude 决定是否调用工具，主要依据：
1. **name**（工具名称是否清晰）
2. **description**（描述是否说明适用场景）
3. **input_schema**（参数定义是否完整）

## 示例

```typescript
const weatherTool = {
  name: "get_weather",
  description: "获取指定城市的天气信息。
                当用户问天气、气温、穿衣建议时使用。
                注意：不支持未来天气预报。",
  inputSchema: {
    type: "object",
    properties: {
      location: {
        type: "string",
        description: "城市名称，如：北京、上海"
      },
      unit: {
        type: "string",
        enum: ["celsius", "fahrenheit"]
      }
    },
    required: ["location"]
  }
}
```

## 适用场景

| 要素 | 最佳实践 |
|------|----------|
| description | 适用场景描述越具体，Claude 越不会乱调用 |
| enum | 能使用 enum 限制的绝不让 Claude 自由输入 |
| strict | 生产环境务必开启 strict 模式 |

---

# Schema 设计：正反对比

> Schema 设计是 Skill 的核心，直接决定 AI 会不会"胡来"。

## ❌ 错误示例：模糊 Schema

```yaml
input_schema:
  type: "object"
  properties:
    query:
      type: "string"  # 太模糊，Claude 不知道传什么
```

**问题**：AI 会产生幻觉，传递任意字符串

## ✅ 正确示例：严格 Schema

```yaml
input_schema:
  type: "object"
  properties:
    query:
      type: "string"
      description: "搜索关键词，如：Python 教程"  # 具体示例
    category:
      type: "string"
      enum: ["tech", "life", "work"]  # 限制可选值
  required: ["query"]  # 明确必填
  strict: true  # 生产环境必须开启
```

---

# ⚡ 重要：strict 模式

> 生产环境务必开启 strict 模式！

## 什么是 strict 模式？

```typescript
// 不开启 strict（默认）
inputSchema: {
  type: "object",
  // AI 可能传递额外字段，或类型不匹配
}

// 开启 strict
inputSchema: {
  type: "object",
  strict: true,  // 严格匹配，不允许额外字段
  // AI 必须完全按照 Schema 传递参数
}
```

## strict 模式的作用

| 特性 | 无 strict | 有 strict |
|------|----------|----------|
| 额外字段 | 允许 | ❌ 拒绝 |
| 类型匹配 | 宽松 | 严格 |
| 生产可用 | ❌ 不推荐 | ✅ 推荐 |

<div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
<strong>⚠️ 生产环境警告</strong>：不使用 strict 模式的 Tool 就像没有类型检查的代码，AI 行为不可预测。
</div>

---

# Skill Frontmatter 配置表格

> 根据 Claude Code 官方文档，Skill 支持以下配置项。

| 属性 | 作用 | 必需 | 示例 |
|------|------|------|------|
| name | 技能名称 | 推荐 | my-skill |
| description | 何时使用 | 推荐 | 代码审查技能 |
| disable-model-invocation | 手动触发 | 可选 | true |
| user-invocation | Claude 自动触发 | 可选 | false |
| allowed-tools | 可用工具限制 | 可选 | [Read, Grep] |
| context | 运行模式 | 可选 | fork |
| agent | 子代理类型 | 可选 | Explore |

## 详细说明

### disable-model-invocation
- `true`：仅用户手动触发（如 `/deploy`）
- `false`（默认）：AI 可以自动触发

### allowed-tools
```yaml
---
allowed-tools: [Read, Grep, Bash, mcp__github__*]
---
```
限制 Skill 可使用的工具，确保安全。

### context
- `fork`：在子代理中运行，不影响主对话
- `default`：在当前对话中运行

---

# 动态上下文注入

> 使用 !`command`` 语法让 Skill 执行前先运行命令获取最新信息。

## 定义

`!`command`` 语法会在 Skill 执行前运行命令，将输出插入到提示中。

## 示例

```yaml
---
name: pr-summary
description: 总结 PR 变更
context: fork
agent: Explore
allowed-tools: [Bash]
---

!`gh pr diff --stat`
!`gh pr view --comments`

请根据以上信息总结 PR 的变更要点。
```

## 工作原理

1. 用户调用 `/pr-summary`
2. Skill 执行前先运行 `gh pr diff --stat`
3. 命令输出自动插入到提示中
4. AI 基于最新信息生成总结

---

# 实战：反面教材 vs 高质量 Skill

### ❌ 典型的"废柴" Skill (AI 会到处乱用)

```yaml
name: check_code
description: 检查代码质量 # 边界模糊，AI 无论写什么代码都想调用一下
params:
  files: "要检查的文件" # 类型不明
```

### ✅ 符合最佳实践的工业级 Skill

```yaml
name: security-audit
description: >
  执行深度安全审计。
  触发时机：用户输入 /audit，或修改了鉴权 (auth) 相关逻辑后。
  限制：仅适用于 src/api 目录下的服务端代码，不要用于前端 UI 组件。
trigger: /audit

schema:
  type: object
  required: [target_dir, severity_level]
  properties:
    target_dir:
      type: string
      description: 必须是一个相对路径，如 src/api/users
    severity_level:
      type: string
      enum: [high, critical] # 强约束 AI 只能选这两个
```

---
layout: center
---

# 本章小结：构建心法

<v-clicks>

1. **Description 是灵魂**：它是 AI 决定是否调用该工具的唯一依据。
2. **Schema 是护城河**：用枚举 (Enum) 和强类型框死 AI 的"幻觉"。
3. **strict 模式**：生产环境必须开启。
4. **把 AI 当"法盲"**：规则必须写得绝对明确，不能有任何模棱两可的用词。
5. **动态注入**：使用 !`command`` 获取最新信息。

</v-clicks>
