# 4. Server 开发 TypeScript

## MCP SDK

```bash
npm install @modelcontextprotocol/sdk
```

---

# 基础 Server 结构

```typescript
import { Server } from '@modelcontextprotocol/sdk/server/index.js';
import { StdioServerTransport } from '@modelcontextprotocol/sdk/server/stdio.js';
import {
  CallToolRequestSchema,
  ListToolsRequestSchema,
} from '@modelcontextprotocol/sdk/types.js';

const server = new Server(
  { name: 'my-mcp-server', version: '1.0.0' },
  { capabilities: { tools: {} } }
);
```

---

# 定义工具

```typescript
server.setRequestHandler(ListToolsRequestSchema, async () => {
  return {
    tools: [
      {
        name: 'get_weather',
        description: '获取指定城市的天气',
        inputSchema: {
          type: 'object',
          properties: {
            city: { type: 'string', description: '城市名称' }
          },
          required: ['city']
        }
      }
    ]
  };
});
```

---

# 处理工具调用

```typescript
server.setRequestHandler(CallToolRequestSchema, async (request) => {
  const { name, arguments: args } = request.params;

  if (name === 'get_weather') {
    // 实现业务逻辑
    const weather = await fetchWeather(args.city);
    return { content: [{ type: 'text', text: weather }] };
  }

  throw new Error(`Unknown tool: ${name}`);
});
```

---

# 启动服务器

```typescript
const transport = new StdioServerTransport();
await server.connect(transport);
```

<v-click>

**完整示例**: 参考 [Microsoft MCP for Beginners](https://github.com/microsoft/mcp-for-beginners)

</v-click>

---

# 最佳实践

<div class="grid grid-cols-2 gap-4">

* **清晰描述**: 让 AI 理解工具用途

* **完整参数**: 类型、描述、必需项

* **错误处理**: 返回有意义的错误信息

* **类型安全**: 使用 TypeScript 确保类型正确

</div>

---

# ⚠️ 重要：SDK 版本选择

| 版本 | 状态 | 适用场景 |
|------|------|---------|
| **V1.x** | ✅ 生产可用 | 所有生产环境推荐使用 |
| V2 | ⚠️ pre-alpha | 不推荐生产使用 |

**建议**：生产环境使用 V1.x 版本

---

# 5. Client 开发 TypeScript

> MCP 不仅要会写 Server，还要会写 Client。

## 定义

**MCP Client** 是连接到 MCP Server 并调用其工具的客户端。

## 应用场景

| 场景 | 说明 |
|------|------|
| 自研 AI 应用 | 你的 AI 应用需要调用外部 MCP Server |
| 测试 MCP Server | 开发时用来调试 Server |
| 聚合多个 Server | 一个 Client 连接多个 Server，统一管理 |

## 安装依赖

```bash
npm install @modelcontextprotocol/client
```

## 基础 Client 代码

```typescript
import { Client } from '@modelcontextprotocol/sdk/client/index.js';
import { StdioClientTransport } from '@modelcontextprotocol/sdk/client/stdio.js';

// 1. 创建 Client
const client = new Client(
  { name: 'my-mcp-client', version: '1.0.0' },
  { capabilities: {} }
);

// 2. 配置传输层（连接到 Server）
const transport = new StdioClientTransport({
  command: 'node',
  args: ['/path/to/your/mcp-server.js']
});
await client.connect(transport);

// 3. 调用工具
const result = await client.callTool({
  name: 'get_weather',
  arguments: { city: 'Beijing' }
});

console.log(result);
// 输出: { content: [{ type: 'text', text: '北京今天天气晴朗，气温25°C' }] }
```

## 获取可用工具列表

```typescript
// 获取 Server 提供的所有工具
const tools = await client.request(
  { method: 'tools/list' },
  { tools: [{ name: 'get_weather', description: '...', ... }] }
);

console.log(tools.map(t => t.name));
// 输出: ['get_weather', 'search', ...]
```

## 完整示例：天气应用

```typescript
import { Client } from '@modelcontextprotocol/sdk/client/index.js';
import { StdioClientTransport } from '@modelcontextprotocol/sdk/client/stdio.js';

async function main() {
  const client = new Client(
    { name: 'weather-app', version: '1.0.0' },
    { capabilities: {} }
  );

  const transport = new StdioClientTransport({
    command: 'npx',
    args: ['-y', '@modelcontextprotocol/server-weather']
  });

  await client.connect(transport);

  // 调用天气工具
  const weather = await client.callTool({
    name: 'get_weather',
    arguments: { city: 'Beijing', unit: 'celsius' }
  });

  console.log(weather.content[0].text);
  // 输出: 北京今天天气晴朗，气温25°C

  await client.close();
}

main();
```

---

layout: center
---
# 本章小结：Server 与 Client 开发

<v-clicks>

1. **Server 开发**: 定义工具、处理调用、返回结果
2. **Client 开发**: 连接 Server、调用工具、获取结果
3. **版本选择**: 生产环境用 V1.x，V2 是 pre-alpha

</v-clicks>
